/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   clipping_z.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: frapp <frapp@student.42.fr>                +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2024/04/26 15:27:09 by frapp             #+#    #+#             */
/*   Updated: 2024/05/08 23:42:07 by frapp            ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "includes/cub3D.h"
#include "MLX42/include/MLX42/MLX42.h"

/*
	Todo:
	- refactor
	(- later: optimize the with knowledge what the plane is exactly)
*/

// d * line_direct is the line
// dot(plane_n, plane_p - any_point_on_plane) == 0 is plane
// dot(plane_p - (line_start + d * line_direct), plane_n) == 0  means line_start + d * line_direct is intersection
// sinece plane_p and line_start + d * line_direct are points on the plane this means that these two lines are parallel:
// plane_p + x * plane_n and line_start + d * line_direct + x * plane_n
// which means
// dot(plane_p, plane_n) == dot(line_start + d * line_direct, plane_n)
//==
// dot(plane_p, plane_n) == dot(line_start, plane_n) + dot(d * line_direct, plane_n)
//==
// dot(plane_p, plane_n) == dot(line_start, plane_n) + d * dot(line_direct, plane_n)
// ==
// dot(plane_p, plane_n) / dot(line_direct, plane_n) == dot(line_start, plane_n) / dot(line_direct, plane_n) + d
// ==
// (dot(plane_p, plane_n) - dot(line_start, plane_n)) / dot(line_direct, plane_n) == d
// now d * line_direct + line_start == intersection
t_vec3	line_zplane_intersection(t_vec3 line_start, t_vec3 line_end, bool z_near)
{
	static const t_vec3	plane_far = {.x=0, .y=0,.z = Z_FAR};
	static const t_vec3	plane_n = {.x=0, .y=0,.z = 1};
	static const t_vec3	plane_near = {.x=0, .y=0,.z = Z_NEAR};
	t_vec3				plane_p;
	if (z_near)
		plane_p = plane_near;
	else
		plane_p = plane_far;
	t_vec3	intersection;
	t_vec3	line_direct;
	float	d;
	float	dot_directline_nplane;

	line_direct = v3_sub(line_end, line_start);
	unit_vec3(&line_direct);
	dot_directline_nplane = dot_prod_unit(line_direct, plane_n);
	if (zero_f(dot_directline_nplane))
	{
		assume(0);
		return (line_start);
	}
	d = (dot_prod_unit(plane_p, plane_n) - dot_prod_unit(line_start, plane_n)) / dot_directline_nplane;
	intersection = v3_add(v3_scale(line_direct, d), line_start);
	intersection.u = d * (line_end.u - line_start.u);
	intersection.v = d * (line_end.v - line_start.v);
	return (intersection);
}

int8_t	clipping_z_far(t_triangle *tri, t_triangle *clipped)
{
	
	int8_t				i;
	t_vec3				cur_start;
	int8_t				inside_points;
	int8_t				inside_index[3];

	inside_points = 0;
	i = 0;
	while (i < 3)
	{
		if (tri->p[i].z < Z_FAR)
			inside_index[inside_points++] = i;
		i++;
	}
	if (inside_points == 0)
		return (0);
	if (inside_points == 3)
	{
		*clipped = *tri;
		return (1);
	}
	if (inside_points == 1)
	{
		clipped[0] = *tri;
		cur_start = tri->p[inside_index[0]];
		int8_t	outside_index1 = (inside_index[0] ^ 3) & 1; //xd
		int8_t	outside_index2 = (inside_index[0] ^ 3) & 2;
		clipped[0].p[outside_index1] = line_zplane_intersection(cur_start, tri->p[outside_index1], false);
		clipped[0].p[outside_index2] = line_zplane_intersection(cur_start, tri->p[outside_index2], false);
		return (1);
	}
	clipped[0] = *tri;
	clipped[1] = *tri;
	int8_t	outside_index = (inside_index[0] ^ 3) & (inside_index[1] ^ 3);
	
	t_vec3	intersec1 = line_zplane_intersection(tri->p[inside_index[0]], tri->p[outside_index], false);
	t_vec3	intersec2 = line_zplane_intersection(tri->p[inside_index[1]], tri->p[outside_index], false);
	
	clipped[0].p[outside_index] = intersec1;
	clipped[1].p[inside_index[0]] = intersec1;
	clipped[1].p[outside_index] = intersec2;
	return (2);
}

int8_t	clipping_z_near(t_triangle *tri, t_triangle *clipped)
{
	int8_t				i;
	t_vec3				cur_start;
	int8_t				inside_points;
	int8_t				inside_index[3];

	inside_points = 0;
	i = 0;
	while (i < 3)
	{
		if (tri->p[i].z > Z_NEAR)
			inside_index[inside_points++] = i;
		i++;
	}
	if (inside_points == 0) //inside_points == 2 ||
		return (0);
	if (inside_points == 3)
	{
		*clipped = *tri;
		return (1);
	}
	if (inside_points == 1)
	{
		clipped[0] = *tri;
		cur_start = tri->p[inside_index[0]];
		int8_t	outside_index1 = (inside_index[0] ^ 3) & 1; //xd
		int8_t	outside_index2 = (inside_index[0] ^ 3) & 2;
		clipped[0].p[outside_index1] = line_zplane_intersection(cur_start, tri->p[outside_index1], true);
		clipped[0].p[outside_index2] = line_zplane_intersection(cur_start, tri->p[outside_index2], true);
		return (1);
	}
	//problem here
	i = 0;
	while (i < 3)
	{
		printf("%d: %f\n", i, tri->p[i].z);
		i++;
	}
	clipped[0] = *tri;
	clipped[1] = *tri;
	int8_t	outside_index = (inside_index[0] ^ 3) & (inside_index[1] ^ 3);
	t_vec3	intersec1 = line_zplane_intersection(tri->p[inside_index[0]], tri->p[outside_index], true);
	t_vec3	intersec2 = line_zplane_intersection(tri->p[inside_index[1]], tri->p[outside_index], true);
	static int a= 0;
	clipped[0].p[outside_index] = intersec1;
	
	clipped[1].p[inside_index[0]] = clipped[1].p[inside_index[1]];
	clipped[1].p[inside_index[1]] = intersec2;
	clipped[1].p[outside_index] = intersect1;
	//clipped[1].p[inside_index[0]] = intersec1;
	//clipped[1].p[outside_index] = intersec2;
	return (2);
}

